#!/bin/bash
set -euo pipefail

# --- Colors & Prompt ---
GREEN="\e[1;32m"
BLUE="\e[1;34m"
RESET="\e[0m"
HOSTNAME=$(hostname)
IP_ADDR=$(hostname -I | awk '{print $1}')
PROMPT="${GREEN}ubuntu@$HOSTNAME${RESET}:${BLUE}~${RESET}\$"

# --- LDAP Config Variables ---
LDAP_DOMAIN="example.local"
LDAP_ORG="TYCS_LDAP"
LDAP_ADMIN_PASS="Admin@123"

# --- Helper function for commands ---
run_cmd() {
    echo -e "${PROMPT} $*"
    sleep 1
    eval "$*"
    echo ""
    sleep 1
}

# Convert domain to dc components
IFS='.' read -r -a DOMAIN_PARTS <<< "$LDAP_DOMAIN"
DC_STRING=$(printf "dc=%s," "${DOMAIN_PARTS[@]}")
DC_STRING=${DC_STRING%,}  # remove trailing comma

clear
echo -e "${GREEN}===== INSTALL & CONFIGURE OPENLDAP =====${RESET}\n"

# Step 1: Update system
run_cmd "sudo apt update -y"

# Step 2: Preseed debconf for slapd
echo -e "${GREEN}Pre-configuring slapd package...${RESET}"
sudo debconf-set-selections <<EOF
slapd slapd/internal_adminpw password $LDAP_ADMIN_PASS
slapd slapd/internal_adminpw_again password $LDAP_ADMIN_PASS
slapd slapd/domain string $LDAP_DOMAIN
slapd slapd/organization string $LDAP_ORG
slapd slapd/no_configuration boolean false
slapd slapd/password1 password $LDAP_ADMIN_PASS
slapd slapd/password2 password $LDAP_ADMIN_PASS
slapd slapd/backend select HDB
slapd slapd/purge_database boolean false
slapd slapd/move_old_database boolean true
slapd slapd/allow_ldap_v2 boolean false
EOF

# Step 3: Install OpenLDAP server and client
run_cmd "sudo apt install slapd ldap-utils -y"

# Step 4: Verify LDAP service status
run_cmd "sudo systemctl status slapd --no-pager | head -n 10"

# Step 5: Backup original LDAP config
run_cmd "sudo cp -r /etc/ldap /etc/ldap.backup"

# Step 6: Add base LDIF
BASE_LDIF="/tmp/base.ldif"
cat <<EOL > $BASE_LDIF
dn: ou=People,$DC_STRING
objectClass: organizationalUnit
ou: People

dn: ou=Groups,$DC_STRING
objectClass: organizationalUnit
ou: Groups

dn: cn=admin,$DC_STRING
objectClass: organizationalRole
cn: admin
description: LDAP administrator
EOL

run_cmd "sudo ldapadd -x -D cn=admin,$DC_STRING -w $LDAP_ADMIN_PASS -f $BASE_LDIF"

# Step 7: Test LDAP query
run_cmd "ldapsearch -x -LLL -H ldap://$IP_ADDR -b $DC_STRING"

# Step 8: Enable slapd to start at boot
run_cmd "sudo systemctl enable slapd"

# Step 9: Final message
echo -e "\n${GREEN}âœ… OpenLDAP installation and basic configuration completed!${RESET}"
echo -e "${GREEN}LDAP Server: ldap://$IP_ADDR${RESET}"
echo -e "${GREEN}Admin DN: cn=admin,$DC_STRING${RESET}"
echo -e "${GREEN}Admin Password: $LDAP_ADMIN_PASS${RESET}"
echo -e "${GREEN}You can now add users and groups using LDIF files.${RESET}"
