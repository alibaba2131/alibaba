#!/bin/bash
set -euo pipefail

GREEN="\e[1;32m"
BLUE="\e[1;34m"
RESET="\e[0m"
hostname=$(hostname)
ip_addr=$(hostname -I | awk '{print $1}')
interface=$(ip -o -4 route show to default | awk '{print $5}')
subnet=$(ip -o -4 addr show $interface | awk '{print $4}' | cut -d/ -f1 | awk -F. '{print $1"."$2"."$3".0"}')
rev_zone=$(echo $subnet | awk -F. '{print $3"."$2"."$1}')
PROMPT="${GREEN}ubuntu@$hostname${RESET}:${BLUE}~${RESET}\$"

type_command() {
    echo -e "${PROMPT} $1"
    sleep 1
}

clear
echo -e "${GREEN}===== TYBSc CS Practical 05: Configure DNS Server (BIND9) =====${RESET}\n"

# Update & install
type_command "sudo apt update -y"
sudo apt update -y
type_command "sudo apt install bind9 bind9utils bind9-doc -y"
sudo apt install bind9 bind9utils bind9-doc -y

# Backup original configs
type_command "Backing up BIND config files"
sudo cp /etc/bind/named.conf.options /etc/bind/named.conf.options.bak
sudo cp /etc/bind/named.conf.local /etc/bind/named.conf.local.bak

# Configure named.conf.options
type_command "Configuring named.conf.options"
sudo tee /etc/bind/named.conf.options > /dev/null <<EOF
acl MYLAN {
    $ip_addr;
};

options {
    directory "/var/cache/bind";
    allow-query { $subnet/24; localhost; };
    recursion yes;

    forwarders {
        8.8.8.8;
        1.1.1.1;
    };

    dnssec-validation no;
    listen-on { any; };
};
EOF

# Configure named.conf.local
type_command "Configuring named.conf.local"
sudo tee /etc/bind/named.conf.local > /dev/null <<EOF
zone "tycs.local" {
    type master;
    file "/etc/bind/db.tycs.local";
};

zone "$rev_zone.in-addr.arpa" {
    type master;
    file "/etc/bind/db.$rev_zone.0";
};
EOF

# Create forward zone file
type_command "Creating forward zone file"
sudo cp /etc/bind/db.local /etc/bind/db.tycs.local
sudo tee /etc/bind/db.tycs.local > /dev/null <<EOF
\$TTL    604800
@       IN      SOA     ns1.tycs.local. root.tycs.local. (
                        2
                        604800
                        86400
                        2419200
                        604800 )
@       IN      NS      ns1.tycs.local.
ns1     IN      A       $ip_addr
www     IN      A       $ip_addr
ftp     IN      A       $ip_addr
EOF

# Create reverse zone file
type_command "Creating reverse zone file"
sudo cp /etc/bind/db.127 /etc/bind/db.$rev_zone.0
sudo tee /etc/bind/db.$rev_zone.0 > /dev/null <<EOF
\$TTL    604800
@       IN      SOA     ns1.tycs.local. root.tycs.local. (
                        2
                        604800
                        86400
                        2419200
                        604800 )
@       IN      NS      ns1.tycs.local.
$(echo $ip_addr | awk -F. '{print $4}')      IN      PTR     ns1.tycs.local.
EOF

# Check and restart BIND
type_command "Checking config"
sudo named-checkconf
sudo named-checkzone tycs.local /etc/bind/db.tycs.local

type_command "Restarting BIND9"
sudo systemctl restart bind9
sudo systemctl enable bind9

# Test DNS
type_command "Testing forward lookup"
dig @localhost www.tycs.local
type_command "Testing reverse lookup"
dig -x $ip_addr

echo -e "\n${GREEN}âœ” Practical 05 completed successfully.${RESET}"
echo -e "${GREEN}Hostname: $hostname | IP: $ip_addr | Subnet: $subnet/24${RESET}"
echo -e "${GREEN}Forward and Reverse Lookup verified.${RESET}"
